# MFKSpriterKit
iOS implementation of SCML Spriter Kit object.

You can check the Spriter here - https://brashmonkey.com/

MFKSpriterKit is an XCode project for open, parse and play SCML files without any external engine. MFKSpriterKit use OpenGLES 2.0 only. Support ARC and non ARC.

### SCMLObject library
Locate in lib/SCMLObject folder. Only two files - SCMLObject.m and SCMLObject.h.
Current version of SCMLObject support latest Spriter R9 release and texture atlas generated by CodeAndWeb TexturePacker https://www.codeandweb.com/texturepacker

Only 3 files need:

  - PNG Texture atlas pictures - generated by TexturePacker
  - XML Texture atlas data - generated by TexturePacker
  - SCML file with character - generated by Spriter

So, for your project need SCMLObject library and part of rendering code.

### External library RaptureXML
SCMLObject use [RaptureXML] [rapt] to load all XML files. I fix this lib to support non ARC as well. And this is smallest and fastest XML lib I found.

### Loading SCML
Usage example you can check into [GameViewController.m] [GmVc]
```
//SCML Textures engine
scmlTextures = [SCMLTextures newScmlTextures];
//textureScale is string with "", "@2x" or "@4x". This strign will add to texture file name.
[scmlTextures setScalePrefix:textureScale];
//scaleFactor 1, 2, 4 ect.
[scmlTextures setScaleFactor:scaleFactor]; 

//SCML Object
scmlObject = [SCMLObject newScmlObject];
[scmlObject setTextures:scmlTextures];
[scmlObject setPixelSizeX:nPixel];
[scmlObject setPixelSizeY:nPixel];
//Base scale is the ratio between SCML pixel size and texture pixel size. 4 in here - it is base SCML scale relatively texture, mean texture with scale 4 is 1:1 texture with use in SCML.
[scmlObject setBaseScale:(GLfloat) [scmlTextures scaleFactor] / 4];
[scmlObject openSCML:[[NSBundle mainBundle] pathForResource:currentSCMLName ofType:@"scml"] textureAtlas:[[NSBundle mainBundle] pathForResource:[NSString stringWithFormat:@"%@%@", currentSCMLName, [scmlTextures scalePrefix]] ofType:@"xml"]]; 
```
### Render SCML
To render SCML you need to use [SCML fragment shader] [ShFs] and [SCML vertex shader] [ShVs].

SCMLObject generate VBO buffer for each sprite.

Render:
```
for (SCMLSpriteTimelineKey *key in [scmlObject spritesToDraw]) {
    SCMLFile *file = [key file];
    glActiveTexture(GL_TEXTURE0);
    glBindTexture(GL_TEXTURE_2D, [file texture]);
    //VBO
    glBindVertexArrayOES(flipHorizontal ? [file vah] : [file va]);
    glUniformMatrix4fv([[shaderPrograms program:SP_SCML] uniform:U_MODELVIEWPROJECTION_MATRIX], 1, 0, modelViewProjectionMatrix.m);
    glUniform1f([[shaderPrograms program:SP_SCML] uniform:U_TEXTUREUSE], 1.0f);
    glUniform4f([[shaderPrograms program:SP_SCML] uniform:U_COLOR], 1.0f, 1.0f, 1.0f, [[key info] a]);
    glUniform1i([[shaderPrograms program:SP_SCML] uniform:U_TEXTURE], 0);
    if (flipHorizontal) {
        glUniform2f([[shaderPrograms program:SP_SCML] uniform:U_PIVOT], -([file w] * (1.0f - [key pivotX])) * nPixel, -([file h] * [key pivotY]) * nPixel);
        glUniform2f([[shaderPrograms program:SP_SCML] uniform:U_TRANSLATE], -[[key info] x] * nPixel, [[key info] y] * nPixel);
        glUniform1f([[shaderPrograms program:SP_SCML] uniform:U_ROTATE], [[key info] angle]);
    } else {
        glUniform2f([[shaderPrograms program:SP_SCML] uniform:U_PIVOT], -([file w] * [key pivotX]) * nPixel, -([file h] * [key pivotY]) * nPixel);
        glUniform2f([[shaderPrograms program:SP_SCML] uniform:U_TRANSLATE], [[key info] x] * nPixel, [[key info] y] * nPixel);
        glUniform1f([[shaderPrograms program:SP_SCML] uniform:U_ROTATE], -[[key info] angle]);
    }
    glUniform2f([[shaderPrograms program:SP_SCML] uniform:U_BASIC_TRANSLATE], 0.0f, 0.0f);
    glUniform2f([[shaderPrograms program:SP_SCML] uniform:U_SCALE], [[key info] scaleX], [[key info] scaleY]);
    glUniform2f([[shaderPrograms program:SP_SCML] uniform:U_BASIC_SCALE], nScale, nScale);
    glUniform1f([[shaderPrograms program:SP_SCML] uniform:U_BASIC_ROTATE], basicRotate);
    glUniform2f([[shaderPrograms program:SP_SCML] uniform:U_SCML_BASE_SCALE], [scmlObject baseScale], [scmlObject baseScale]);
    glDrawArrays(GL_TRIANGLES, 0, 6);
} 
```

### Animation
To animate SCML character need to update currentTime property of SCMLObject.
```
[scmlObject setCurrentTime:currentTime * 1000];
currentTime +=  self.timeSinceLastUpdate; 
```

### Bones
SCMLObject library also support bones render. Can try it with define SCML_BONES_DRAW in SCMLObject.h

Render bones:
```
for (SCMLBoneTimelineKey *key in [scmlObject bonesToDraw]) {
    glBindVertexArrayOES([[key bone] va]);
    glUniformMatrix4fv([[shaderPrograms program:SP_SCML] uniform:U_MODELVIEWPROJECTION_MATRIX], 1, 0, modelViewProjectionMatrix.m);
    glUniform1f([[shaderPrograms program:SP_SCML] uniform:U_TEXTUREUSE], 0.0f);
    glUniform4f([[shaderPrograms program:SP_SCML] uniform:U_COLOR], 0.0f, 1.0f, 0.0f, 0.5f);
    glUniform1i([[shaderPrograms program:SP_SCML] uniform:U_TEXTURE], 0);
    glUniform2f([[shaderPrograms program:SP_SCML] uniform:U_PIVOT], 0.0f, (-([key width] / 2) * nPixel));
    if (flipHorizontal) {
        glUniform2f([[shaderPrograms program:SP_SCML] uniform:U_TRANSLATE], -[[key info] x] * nPixel, [[key info] y] * nPixel);
        glUniform1f([[shaderPrograms program:SP_SCML] uniform:U_ROTATE], [[key info] angle] + 180);
    } else {
        glUniform2f([[shaderPrograms program:SP_SCML] uniform:U_TRANSLATE], [[key info] x] * nPixel, [[key info] y] * nPixel);
        glUniform1f([[shaderPrograms program:SP_SCML] uniform:U_ROTATE], -[[key info] angle]);
    }
    glUniform2f([[shaderPrograms program:SP_SCML] uniform:U_BASIC_TRANSLATE], 0.0f, 0.0f);
    glUniform2f([[shaderPrograms program:SP_SCML] uniform:U_SCALE], [[key info] scaleX], [[key info] scaleY]);
    glUniform2f([[shaderPrograms program:SP_SCML] uniform:U_BASIC_SCALE], nScale, nScale);
    glUniform1f([[shaderPrograms program:SP_SCML] uniform:U_BASIC_ROTATE], basicRotate);
    glUniform2f([[shaderPrograms program:SP_SCML] uniform:U_SCML_BASE_SCALE], [scmlObject baseScale], [scmlObject baseScale]);
    glDrawArrays(GL_TRIANGLES, 0, 6);
}
```

### About me
[Github] [mefik], [Google+] [G+], 

[//]: # ()
   [G+]: <https://plus.google.com/+MaximFilippov>
   [mefik]: <https://github.com/mefikru>

   [rapt]: <https://github.com/mefikru/MFKSpriterKit/tree/master/libs/RaptureXML>
   [GmVc]: <https://github.com/mefikru/MFKSpriterKit/blob/master/MFKSpriterKit/GameViewController.m>
   [ShFs]: <https://github.com/mefikru/MFKSpriterKit/blob/master/MFKSpriterKit/Resources/Shaders/SCML.fsh>
   [ShVs]: <https://github.com/mefikru/MFKSpriterKit/blob/master/MFKSpriterKit/Resources/Shaders/SCML.vsh>
  